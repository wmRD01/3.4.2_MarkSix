{"version":3,"sources":["file:///C:/CocosProject/3.4.2_MarkSix/assets/Script/Contorll/Lobby/Page/Point/PanelTopRank.ts"],"names":["instantiate","Node","Prefab","_decorator","AssetType","AssetMng","BaseComponent","AutoFollow","RankItmeData","RequestGPG","PublicModel","PublicData","Player","LobbyStateEvent","ccclass","property","PanelTopRank","onLoad","reset","start","setEvent","NextIssueID","onEnable","waitStateCheck","Sprite","console","log","layoutRank","children","length","requesTopScore","removeAllChildren","labelContent","spriteBGContent","node","active","Promise","resolve","reject","body","Body","NeedToken","TopScore","todayDate","Date","getInstance","today","sDate","getFullYear","getMonth","eDate","getDate","sign","convertSign","convert","URLSearchParams","toString","Request","setToken","gpgToken","fetchData","gpgUrlPlayApi","API","responseTopScore","bind","response","index","data","totalScore","_node","prefabRankItem","_class","getComponent","init","labelName","addComponent","createNewTarget","labelPointCount","addChild"],"mappings":"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","sourcesContent":["import { instantiate, Node, Prefab, _decorator } from 'cc';\r\nimport { AssetType } from '../../../../Enum/AssetType';\r\nimport AssetMng from '../../../../Manager/AssetMng';\r\nimport BaseComponent from '../../../../Model/ComponentBase';\r\nimport AutoFollow from '../../../../Model/AutoFollow';\r\nimport RankItmeData from '../../../../Model/RankItmeData';\r\nimport { RequestGPG } from '../../../Api/GPGAPI/RequestGPG';\r\nimport PublicModel from '../../../../Model/PublicModel';\r\nimport PublicData from '../../../../Model/PublicData';\r\nimport { ResponseGPG } from '../../../Api/GPGAPI/ResponseGPG';\r\nimport Player from '../../../../Model/Player';\r\nimport { LobbyStateEvent } from '../../../../Enum/LobbyStateEvent';\r\nconst { ccclass, property } = _decorator;\r\n@ccclass('PanelTopRank')\r\nexport default class PanelTopRank extends BaseComponent {\r\n    @property(Prefab)\r\n    prefabRankItem: Prefab\r\n    @property(Node)\r\n    layoutRank: Node\r\n    @property(Node)\r\n    labelContent: Node;\r\n    @property(Node)\r\n    spriteBGContent: Node;\r\n    onLoad() {\r\n        super.onLoad()\r\n        this.reset()\r\n    }\r\n    start() {\r\n        this.setEvent(LobbyStateEvent.NextIssueID, this.reset)\r\n    }\r\n    async onEnable() {\r\n        await AssetMng.waitStateCheck(AssetType.Sprite)\r\n        console.log(this.layoutRank.children.length);\r\n\r\n        if (this.layoutRank.children.length == 0)\r\n            await this.requesTopScore()\r\n    }\r\n    async reset() {\r\n        this.layoutRank.removeAllChildren()\r\n        this.labelContent.removeAllChildren()\r\n        this.spriteBGContent.removeAllChildren()\r\n        if (this.node.active) {\r\n            await this.requesTopScore()\r\n        }\r\n    }\r\n    async requesTopScore() {\r\n        return new Promise<void>(async (resolve, reject) => {\r\n            const body = new RequestGPG.Body.NeedToken.TopScore()\r\n            const todayDate = new Date(PublicData.getInstance.today)\r\n            body.sDate = `${todayDate.getFullYear()}-${todayDate.getMonth() + 1}-1`\r\n            body.eDate = `${todayDate.getFullYear()}-${todayDate.getMonth() + 1}-${todayDate.getDate()}`\r\n            body.sign = PublicModel.getInstance.convertSign(body, RequestGPG.Body.NeedToken.TopScore)\r\n            let convert = new URLSearchParams(body).toString()\r\n            console.log(body);\r\n            console.log(convert);\r\n            await new RequestGPG.Request()\r\n                .setToken(Player.getInstance.gpgToken)\r\n                .fetchData(`${PublicData.getInstance.gpgUrlPlayApi}${RequestGPG.API.TopScore}?${convert}`, this.responseTopScore.bind(this))\r\n            resolve()\r\n        })\r\n    }\r\n    responseTopScore(response?: ResponseGPG.TopScore.DataClass) {\r\n        console.log(\"排行榜\", response);\r\n        for (let index = 0; index < response.data.length; index++) {\r\n            if (response.data[index].totalScore == 0) continue;\r\n            if (this.layoutRank.children.length >= 100) break;\r\n            let _node = instantiate(this.prefabRankItem)\r\n            let _class = _node.getComponent(RankItmeData)\r\n            _class.init(response.data[index])\r\n            _class.labelName.addComponent(AutoFollow).createNewTarget()\r\n            _class.labelPointCount.addComponent(AutoFollow).createNewTarget()\r\n            // _class.spriteBG.addComponent(AutoFollow).setTarget(_node)\r\n            this.labelContent.addChild(_class.labelName.node)\r\n            this.labelContent.addChild(_class.labelPointCount.node)\r\n            // this.spriteBGContent.addChild(_class.spriteBG.node)\r\n            this.layoutRank.addChild(_node)\r\n        }\r\n    }\r\n\r\n}"]}
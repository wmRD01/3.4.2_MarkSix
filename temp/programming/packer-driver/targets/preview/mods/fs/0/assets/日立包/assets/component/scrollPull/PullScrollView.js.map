{"version":3,"sources":["file:///C:/CocosProject/3.4.2_MarkSix/assets/%E6%97%A5%E7%AB%8B%E5%8C%85/assets/component/scrollPull/PullScrollView.ts"],"names":["Component","instantiate","loader","Prefab","ScrollView","UITransform","Vec3","_decorator","ccclass","property","PullScrollView","onLoad","scrollView","node","getComponent","content","initForListView","jsListView","initAnim","_topPull","_downPull","topLoading","loadRes","errorMessage","prefab","pullTopAnim","parent","addChild","setSiblingIndex","jsPullTopAnim","downLoading","pullAnim","children","length","jsPullDownAnim","refreshView","_topPullCallFunc","_downPullCallFunc","topPullCallFunc","downPullCallFunc","startContentHeight","height","startContentY","position","y","downPullUpdate","topPullUpdate","update","offsetY","getScrollOffset","viewHeight","contentHeight","topPullH","isTouching","isScrolling","Math","ceil","showAction","abs","stopAutoScroll","playing","show","play","hide","scrollToTop","x","z","pulldownUpdate","setListViewUpdate","scrollToBottom","loosenAnim","cleanScale","switchKey","initialled"],"mappings":"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","sourcesContent":["/* jshint esversion:6 */\n\nimport { Component, instantiate, loader, macro, Node, Prefab, ScrollView, UITransform, Vec3, _decorator } from 'cc';\nimport ListViewNew from '../listView/ListViewNew';\nconst { ccclass, property } = _decorator;\n@ccclass('PullScrollView')\nexport default class PullScrollView extends Component {\n    scrollView;\n    content: Node;\n    jsListView;\n    topLoading;\n    downLoading;\n    pullTopAnim;\n    jsPullTopAnim;\n    pullAnim;\n    jsPullDownAnim;\n    topPullCallFunc;\n    downPullCallFunc;\n    startContentHeight;\n    startContentY;\n    showAction;\n    playing;\n\n\n    onLoad() {\n        this.scrollView = this.node.getComponent(ScrollView);\n        if (this.scrollView) {\n            this.content = this.scrollView.content;\n        }\n    }\n\n    // 兼容ListViewNew时初始化执行\n    initForListView(jsListView: ListViewNew) {\n        this.jsListView = jsListView;\n        this.scrollView = jsListView.scrollView;\n        this.content = jsListView.scrollView.content;\n    }\n\n    initAnim(_topPull, _downPull) {\n        if (_topPull && !this.topLoading) {\n            this.topLoading = true;\n            loader.loadRes(\"pfPullTopAnim\", Prefab, (errorMessage, prefab) => {\n                let pullTopAnim = instantiate(prefab);\n                this.content.parent.addChild(pullTopAnim);\n                pullTopAnim.setSiblingIndex(0)\n                let jsPullTopAnim = pullTopAnim.getComponent(\"jsPullTopAnim\");\n                this.pullTopAnim = pullTopAnim;\n                this.jsPullTopAnim = jsPullTopAnim;\n            });\n        }\n        if (_downPull && !this.downLoading) {\n            this.downLoading = true;\n            loader.loadRes(\"pfPullDownAnim\", Prefab, (errorMessage, prefab) => {\n                let pullAnim = instantiate(prefab);\n                this.content.parent.addChild(pullAnim);\n                pullAnim.setSiblingIndex(this.content.parent.children.length)\n                let jsPullDownAnim = pullAnim.getComponent(\"jsPullDownAnim\");\n                this.pullAnim = pullAnim;\n                this.jsPullDownAnim = jsPullDownAnim;\n            });\n        }\n    }\n\n    refreshView(_topPullCallFunc, _downPullCallFunc) {\n        this.initAnim(_topPullCallFunc, _downPullCallFunc);\n        this.topPullCallFunc = _topPullCallFunc;\n        this.downPullCallFunc = _downPullCallFunc;\n        // this.scheduleOnce(()=>{ // 延迟一帧让Widget对齐\n        this.startContentHeight = this.content.getComponent(UITransform).height;\n        this.startContentY = this.startContentY || this.content.position.y;\n        // } 1/30);\n    }\n\n    downPullUpdate() {\n        if (this.downPullCallFunc) {\n            this.downPullCallFunc();\n        }\n    }\n\n    topPullUpdate() {\n        if (this.topPullCallFunc) {\n            this.topPullCallFunc();\n        }\n    }\n\n    update() {\n        if (!this.scrollView || !this.startContentHeight) {\n            return;\n        }\n\n        let offsetY = this.scrollView.getScrollOffset().y;\n        let viewHeight = this.content.parent.getComponent(UITransform).height;\n        let contentHeight = this.content.getComponent(UITransform).height;\n        let topPullH = (offsetY + viewHeight) - contentHeight;\n        let isTouching = this.scrollView.isScrolling();\n\n        if (this.pullTopAnim && Math.ceil(offsetY) < 0) {\n            if (isTouching) {\n                this.showAction = Math.abs(offsetY) > 100;\n            } else {\n                if (this.showAction) {\n                    this.scrollView.stopAutoScroll();\n                    this.showAction = false;\n                    this.playing = true;\n                    this.pullTopAnim.y = viewHeight / 2 - 45;\n                    this.jsPullTopAnim.show();\n                    this.jsPullTopAnim.play(() => {\n                        this.playing = false;\n                        this.jsPullTopAnim.hide();\n                        this.scrollView.scrollToTop();\n                        this.topPullUpdate();\n                    });\n                } else if (!this.playing) {\n                    this.jsPullTopAnim.hide();\n                } else if (this.playing) {\n                    this.scrollView.stopAutoScroll();\n                    this.content.position = new Vec3(this.content.position.x, this.startContentY - 100, this.content.position.z);\n                }\n            }\n        } else if (this.pullAnim && topPullH >= 0) {\n            if (isTouching) {\n                this.pullAnim.y = topPullH > 60 ? -viewHeight / 2 + 60 - 30 : -viewHeight / 2 + topPullH - 30;\n                this.showAction = topPullH > 120;\n                if (topPullH > 60) {\n                    this.jsPullDownAnim.pulldownUpdate(topPullH);\n                }\n            } else {\n                if (this.showAction) {\n                    this.showAction = false;\n                    this.playing = true;\n                    this.content.getComponent(UITransform).height = this.startContentHeight + 90;\n                    this.setListViewUpdate(false);\n                    this.scrollView.stopAutoScroll();\n                    this.scrollView.scrollToBottom(0);\n                    this.jsPullDownAnim.loosenAnim(() => {\n                        this.playing = false;\n                        this.content.getComponent(UITransform).height = this.startContentHeight;\n                        this.scrollView.stopAutoScroll();\n                        this.scrollView.scrollToBottom(0);\n                        this.setListViewUpdate(true);\n                        this.downPullUpdate();\n                    });\n                } else if (!this.playing) {\n                    this.jsPullDownAnim.cleanScale();\n                    this.pullAnim.y = -viewHeight / 2 + topPullH - 30;\n                }\n            }\n        }\n    }\n\n    setListViewUpdate(switchKey) {\n        if (this.jsListView) {\n            this.jsListView.initialled = switchKey;\n        }\n    }\n}\n\n"]}